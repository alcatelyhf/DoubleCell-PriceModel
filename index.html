<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>双细价格体系测算模型</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        header {
            background: linear-gradient(135deg, #1a6dbb 0%, #0c4a8f 100%);
            color: white;
            padding: 25px 30px;
        }
        h1 {
            margin: 0 0 10px 0;
            font-size: 28px;
        }
        .subtitle {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        .strategy-summary {
            background-color: #f0f8ff;
            border-left: 5px solid #1a6dbb;
            padding: 15px;
            margin: 15px 30px;
            border-radius: 0 8px 8px 0;
        }
        .tabs {
            display: flex;
            background-color: #f0f0f0;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }
        .tab.active {
            background-color: white;
            color: #1a6dbb;
            border-top: 3px solid #1a6dbb;
        }
        .tab-content {
            display: none;
            padding: 30px;
        }
        .tab-content.active {
            display: block;
        }
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }
        .step-indicator::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 50px;
            right: 50px;
            height: 2px;
            background-color: #e0e0e0;
            z-index: 1;
        }
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 2;
        }
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e0e0e0;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        .step.active .step-number {
            background-color: #1a6dbb;
            color: white;
        }
        .step-title {
            font-size: 13px;
            text-align: center;
            max-width: 100px;
            color: #666;
        }
        .step.active .step-title {
            color: #1a6dbb;
            font-weight: 600;
        }
        .input-section {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #eaeaea;
        }
        .input-row {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 15px;
            align-items: center;
        }
        .input-group {
            flex: 1;
            min-width: 200px;
            margin-right: 20px;
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
        }
        .input-group input, .input-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 15px;
            transition: border 0.3s;
        }
        .input-group input:focus, .input-group select:focus {
            border-color: #1a6dbb;
            outline: none;
        }
        .input-group input[type="range"] {
            padding: 0;
        }
        .range-value {
            display: inline-block;
            margin-left: 10px;
            font-weight: 600;
            color: #1a6dbb;
        }
        .results-section {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 25px;
            border: 1px solid #eaeaea;
        }
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .result-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            border-left: 4px solid #1a6dbb;
        }
        .result-card h3 {
            margin-top: 0;
            color: #1a6dbb;
            font-size: 18px;
            border-bottom: 1px dashed #eee;
            padding-bottom: 10px;
        }
        .result-value {
            font-size: 28px;
            font-weight: 700;
            color: #0c4a8f;
            margin: 15px 0;
        }
        .result-desc {
            color: #666;
            font-size: 14px;
        }
        .calc-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .calc-table th, .calc-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .calc-table th {
            background-color: #f0f7ff;
            font-weight: 600;
            color: #1a6dbb;
        }
        .calc-table tr:hover {
            background-color: #f9f9f9;
        }
        .formula {
            background-color: #f8f9fa;
            border-left: 4px solid #1a6dbb;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 15px;
        }
        .buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background-color: #1a6dbb;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0c4a8f;
        }
        .btn-secondary {
            background-color: #f0f0f0;
            color: #333;
        }
        .btn-secondary:hover {
            background-color: #e0e0e0;
        }
        .btn-download {
            background-color: #28a745;
            color: white;
        }
        .btn-download:hover {
            background-color: #218838;
        }
        .note {
            font-size: 14px;
            color: #666;
            font-style: italic;
            margin-top: 20px;
        }
        .legend {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }
        .legend-text {
            font-size: 14px;
        }
        footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 14px;
            border-top: 1px solid #eee;
            margin-top: 30px;
        }
        @media (max-width: 768px) {
            .input-group {
                min-width: 100%;
                margin-right: 0;
            }
            .results-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>双细价格体系测算模型</h1>
            <div class="subtitle">基于"竞争性锚定，梯度韧性赋能"五步法架构</div>
            <div class="strategy-summary">
                <strong>核心策略：</strong> 自上而下设计价格体系，锚定制造商建议零售价(MSRP)，通过梯度渠道利润体系实现快速市场抢占与规模营收回笼。
            </div>
        </header>
        
        <div class="tabs">
            <div class="tab active" data-tab="single">单品测算</div>
            <div class="tab" data-tab="multi">多品测算</div>
            <div class="tab" data-tab="scenarios">策略场景</div>
        </div>
        
        <!-- 单品测算标签 -->
        <div class="tab-content active" id="single">
            <div class="step-indicator">
                <div class="step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-title">锚定MSRP</div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-title">代理出厂价</div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-title">渠道利润体系</div>
                </div>
                <div class="step" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-title">动态调控机制</div>
                </div>
                <div class="step" data-step="5">
                    <div class="step-number">5</div>
                    <div class="step-title">结果分析</div>
                </div>
            </div>
            
            <div class="input-section">
                <h2>基础参数设置</h2>
                <div class="input-row">
                    <div class="input-group">
                        <label for="productName">产品名称</label>
                        <input type="text" id="productName" value="甲基化基因癌症早早筛查" placeholder="请输入产品名称">
                    </div>
                    <div class="input-group">
                        <label for="competitorPrice">竞品价（市场指导价水平）</label>
                        <input type="number" id="competitorPrice" value="1200" step="10" placeholder="请输入竞品价格">
                    </div>
                    <div class="input-group">
                        <label for="strategyType">策略选择</label>
                        <select id="strategyType">
                            <option value="A">策略A：主攻-面攻击（上量/引流/套餐钩子）</option>
                            <option value="B">策略B：价值-线攻击（高价值/专业服务）</option>
                        </select>
                    </div>
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label for="msrpRate">MSRP定价比例（竞品价%）</label>
                        <input type="range" id="msrpRate" min="60" max="110" value="85">
                        <span class="range-value" id="msrpRateValue">85%</span>
                        <div class="note">策略A建议：60%-85%，策略B建议：100%-110%</div>
                    </div>
                    <div class="input-group">
                        <label for="factoryDiscount">代理赋能出厂价折扣（MSRP%）</label>
                        <input type="range" id="factoryDiscount" min="30" max="50" value="40">
                        <span class="range-value" id="factoryDiscountValue">40%</span>
                        <div class="note">激化政策：30%-40%，稳健激励：41%-50%</div>
                    </div>
                    <div class="input-group">
                        <label for="floorPriceRate">最低市场保护价比例（MSRP%）</label>
                        <input type="range" id="floorPriceRate" min="80" max="100" value="95">
                        <span class="range-value" id="floorPriceRateValue">95%</span>
                    </div>
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label for="rebateThreshold">返点销售目标（万元）</label>
                        <input type="number" id="rebateThreshold" value="100" step="10" placeholder="返点销售目标">
                    </div>
                    <div class="input-group">
                        <label for="rebateRate">核心代理返点比例（%）</label>
                        <input type="number" id="rebateRate" value="15" step="1" min="0" max="30" placeholder="返点比例">
                    </div>
                    <div class="input-group">
                        <label for="salesVolume">预计年销售量（单位）</label>
                        <input type="number" id="salesVolume" value="1000" step="100" placeholder="预计销售量">
                    </div>
                </div>
            </div>
            
            <div class="results-section">
                <h2>价格体系测算结果</h2>
                
                <div class="results-grid">
                    <div class="result-card">
                        <h3>制造商建议零售价 (MSRP)</h3>
                        <div class="result-value" id="msrpResult">¥1,020</div>
                        <div class="result-desc">
                            计算公式：竞品价 × MSRP定价比例<br>
                            <span id="msrpFormula">1200 × 85% = 1020</span>
                        </div>
                    </div>
                    <div class="result-card">
                        <h3>代理赋能出厂价</h3>
                        <div class="result-value" id="factoryPriceResult">¥408</div>
                        <div class="result-desc">
                            计算公式：MSRP × 出厂价折扣<br>
                            <span id="factoryPriceFormula">1020 × 40% = 408</span>
                        </div>
                    </div>
                    <div class="result-card">
                        <h3>渠道利润空间</h3>
                        <div class="result-value" id="channelMarginResult">¥612</div>
                        <div class="result-desc">
                            计算公式：MSRP - 出厂价<br>
                            <span id="channelMarginFormula">1020 - 408 = 612</span>
                        </div>
                    </div>
                    <div class="result-card">
                        <h3>最低市场保护价（地板价）</h3>
                        <div class="result-value" id="floorPriceResult">¥969</div>
                        <div class="result-desc">
                            计算公式：MSRP × 最低保护价比例<br>
                            <span id="floorPriceFormula">1020 × 95% = 969</span>
                        </div>
                    </div>
                </div>
                
                <h3>渠道利润分析</h3>
                <table class="calc-table">
                    <thead>
                        <tr>
                            <th>渠道层级</th>
                            <th>进货价（出厂价）</th>
                            <th>建议零售价（MSRP）</th>
                            <th>理论利润空间</th>
                            <th>理论毛利率</th>
                            <th>含返点实际毛利率</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>核心代理商（返点前）</td>
                            <td id="coreAgentPrice">¥408</td>
                            <td id="coreAgentMsrp">¥1,020</td>
                            <td id="coreAgentMargin">¥612</td>
                            <td id="coreAgentMarginRate">60%</td>
                            <td id="coreAgentRebateRate">69%</td>
                        </tr>
                        <tr>
                            <td>分销商/服务商</td>
                            <td id="distributorPrice">¥612</td>
                            <td id="distributorMsrp">¥1,020</td>
                            <td id="distributorMargin">¥408</td>
                            <td id="distributorMarginRate">40%</td>
                            <td id="distributorRebateRate">40%</td>
                        </tr>
                    </tbody>
                </table>
                
                <h3>营收与利润测算</h3>
                <table class="calc-table">
                    <thead>
                        <tr>
                            <th>测算项目</th>
                            <th>金额（元）</th>
                            <th>计算说明</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>预计年营收（基于MSRP）</td>
                            <td id="annualRevenueMsrp">¥1,020,000</td>
                            <td>MSRP × 预计销售量</td>
                        </tr>
                        <tr>
                            <td>预计年回款（基于出厂价）</td>
                            <td id="annualRevenueFactory">¥408,000</td>
                            <td>出厂价 × 预计销售量</td>
                        </tr>
                        <tr>
                            <td>我司总毛利空间</td>
                            <td id="companyMargin">¥408,000</td>
                            <td>(出厂价 - 成本) × 销售量（假设成本为0计算）</td>
                        </tr>
                        <tr>
                            <td>渠道总利润空间</td>
                            <td id="totalChannelMargin">¥612,000</td>
                            <td>(MSRP - 出厂价) × 销售量</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="formula">
                    <strong>核心计算公式说明：</strong><br>
                    1. MSRP = 竞品价 × MSRP定价比例<br>
                    2. 代理赋能出厂价 = MSRP × 出厂价折扣<br>
                    3. 渠道利润空间 = MSRP - 代理赋能出厂价<br>
                    4. 最低市场保护价 = MSRP × 最低保护价比例<br>
                    5. 核心代理实际毛利率 = (渠道利润空间 + 返点金额) / MSRP<br>
                    6. 预计年营收（MSRP基准）= MSRP × 预计销售量<br>
                    7. 预计年回款 = 代理赋能出厂价 × 预计销售量
                </div>
                
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #1a6dbb;"></div>
                        <div class="legend-text">我司利润空间</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #28a745;"></div>
                        <div class="legend-text">渠道利润空间</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #ffc107;"></div>
                        <div class="legend-text">返点激励部分</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 多品测算标签 -->
        <div class="tab-content" id="multi">
            <div class="input-section">
                <h2>多产品批量测算</h2>
                <p>在此页面可以同时测算多个产品的价格体系。点击"添加产品"按钮添加更多产品行。</p>
                
                <div id="multiProductTable">
                    <table class="calc-table">
                        <thead>
                            <tr>
                                <th>产品名称</th>
                                <th>竞品价</th>
                                <th>策略</th>
                                <th>MSRP比例</th>
                                <th>出厂价折扣</th>
                                <th>MSRP</th>
                                <th>出厂价</th>
                                <th>渠道利润</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="multiProductBody">
                            <!-- 行将通过JavaScript动态添加 -->
                        </tbody>
                    </table>
                </div>
                
                <div class="buttons">
                    <button class="btn btn-primary" id="addProductBtn">添加产品</button>
                    <button class="btn btn-secondary" id="clearProductsBtn">清空表格</button>
                </div>
                
                <div class="results-section" style="margin-top: 30px;">
                    <h2>多产品汇总分析</h2>
                    <table class="calc-table">
                        <thead>
                            <tr>
                                <th>统计项目</th>
                                <th>数值</th>
                                <th>说明</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>产品总数</td>
                                <td id="productCount">0</td>
                                <td>测算的产品数量</td>
                            </tr>
                            <tr>
                                <td>平均MSRP比例</td>
                                <td id="avgMsrpRate">0%</td>
                                <td>所有产品MSRP比例的平均值</td>
                            </tr>
                            <tr>
                                <td>平均出厂折扣</td>
                                <td id="avgFactoryDiscount">0%</td>
                                <td>所有产品出厂折扣的平均值</td>
                            </tr>
                            <tr>
                                <td>预估总营收（MSRP基准）</td>
                                <td id="totalRevenueMsrp">¥0</td>
                                <td>所有产品MSRP之和 × 假设销售量(100)</td>
                            </tr>
                            <tr>
                                <td>预估总回款</td>
                                <td id="totalRevenueFactory">¥0</td>
                                <td>所有产品出厂价之和 × 假设销售量(100)</td>
                            </tr>
                            <tr>
                                <td>总渠道利润空间</td>
                                <td id="totalChannelMarginMulti">¥0</td>
                                <td>所有产品渠道利润之和 × 假设销售量(100)</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- 策略场景标签 -->
        <div class="tab-content" id="scenarios">
            <div class="input-section">
                <h2>策略场景模拟</h2>
                <p>选择不同的市场策略场景，查看价格体系的变化与影响。</p>
                
                <div class="input-row">
                    <div class="input-group">
                        <label for="scenarioType">策略场景</label>
                        <select id="scenarioType">
                            <option value="aggressive">激进抢占市场</option>
                            <option value="balanced">平衡发展</option>
                            <option value="premium">高端价值定位</option>
                            <option value="channelFocused">渠道驱动型</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="baseCompetitorPrice">基准竞品价</label>
                        <input type="number" id="baseCompetitorPrice" value="1200" step="10">
                    </div>
                </div>
                
                <div class="results-section">
                    <h2>策略场景参数与结果</h2>
                    
                    <table class="calc-table">
                        <thead>
                            <tr>
                                <th>参数项</th>
                                <th>激进抢占市场</th>
                                <th>平衡发展</th>
                                <th>高端价值定位</th>
                                <th>渠道驱动型</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>MSRP定价比例</td>
                                <td>65%-75%</td>
                                <td>80%-90%</td>
                                <td>100%-110%</td>
                                <td>70%-85%</td>
                            </tr>
                            <tr>
                                <td>代理出厂价折扣</td>
                                <td>30%-35%</td>
                                <td>35%-45%</td>
                                <td>45%-50%</td>
                                <td>30%-40%</td>
                            </tr>
                            <tr>
                                <td>渠道利润空间</td>
                                <td>高</td>
                                <td>中等</td>
                                <td>中等偏高</td>
                                <td>非常高</td>
                            </tr>
                            <tr>
                                <td>核心代理返点</td>
                                <td>15%-20%</td>
                                <td>10%-15%</td>
                                <td>8%-12%</td>
                                <td>15%-25%</td>
                            </tr>
                            <tr>
                                <td>市场保护价比例</td>
                                <td>85%-90%</td>
                                <td>90%-95%</td>
                                <td>95%-100%</td>
                                <td>85%-90%</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div id="scenarioResults">
                        <!-- 场景结果将通过JavaScript动态生成 -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="buttons">
            <button class="btn btn-primary" id="recalculateBtn">重新计算</button>
            <button class="btn btn-download" id="downloadExcelBtn">下载Excel测算表</button>
            <button class="btn btn-secondary" id="resetBtn">重置所有参数</button>
        </div>
        
        <footer>
            <p>双细价格体系测算模型 v1.0 | 基于"竞争性锚定，梯度韧性赋能"五步法架构设计</p>
            <p>© 2025 双细价格体系设计 | 本测算模型为内部工作底稿，数据仅供参考</p>
        </footer>
    </div>

    <script>
        // 全局变量
        let multiProducts = [];
        
        // DOM加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
        
        function initializeApp() {
            // 绑定事件监听器
            document.getElementById('recalculateBtn').addEventListener('click', recalculateAll);
            document.getElementById('resetBtn').addEventListener('click', resetAll);
            document.getElementById('downloadExcelBtn').addEventListener('click', downloadExcel);
            document.getElementById('addProductBtn').addEventListener('click', addProductRow);
            document.getElementById('clearProductsBtn').addEventListener('click', clearProducts);
            document.getElementById('scenarioType').addEventListener('change', updateScenario);
            
            // 绑定滑块事件
            bindSliderEvents();
            
            // 绑定标签切换事件
            bindTabEvents();
            
            // 绑定步骤指示器事件
            bindStepEvents();
            
            // 初始计算
            recalculateAll();
            
            // 初始化多产品表格
            initializeMultiProductTable();
            
            // 初始化策略场景
            updateScenario();
        }
        
        function bindSliderEvents() {
            const sliders = [
                {id: 'msrpRate', valueId: 'msrpRateValue'},
                {id: 'factoryDiscount', valueId: 'factoryDiscountValue'},
                {id: 'floorPriceRate', valueId: 'floorPriceRateValue'}
            ];
            
            sliders.forEach(slider => {
                const sliderEl = document.getElementById(slider.id);
                const valueEl = document.getElementById(slider.valueId);
                
                sliderEl.addEventListener('input', function() {
                    valueEl.textContent = this.value + '%';
                    // 根据策略类型限制滑块范围
                    if (slider.id === 'msrpRate') {
                        const strategyType = document.getElementById('strategyType').value;
                        if (strategyType === 'A') {
                            // 策略A：60%-85%
                            if (this.value < 60) this.value = 60;
                            if (this.value > 85) this.value = 85;
                        } else {
                            // 策略B：100%-110%
                            if (this.value < 100) this.value = 100;
                            if (this.value > 110) this.value = 110;
                        }
                        valueEl.textContent = this.value + '%';
                    }
                    recalculateAll();
                });
            });
            
            // 策略类型变化时调整MSRP滑块
            document.getElementById('strategyType').addEventListener('change', function() {
                const msrpSlider = document.getElementById('msrpRate');
                const msrpValue = document.getElementById('msrpRateValue');
                
                if (this.value === 'A') {
                    // 策略A：60%-85%
                    if (msrpSlider.value < 60) msrpSlider.value = 60;
                    if (msrpSlider.value > 85) msrpSlider.value = 85;
                } else {
                    // 策略B：100%-110%
                    if (msrpSlider.value < 100) msrpSlider.value = 100;
                    if (msrpSlider.value > 110) msrpSlider.value = 110;
                }
                
                msrpValue.textContent = msrpSlider.value + '%';
                recalculateAll();
            });
        }
        
        function bindTabEvents() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // 移除所有active类
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // 激活当前标签
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }
        
        function bindStepEvents() {
            const steps = document.querySelectorAll('.step');
            steps.forEach(step => {
                step.addEventListener('click', function() {
                    // 这里可以扩展为点击步骤跳转到相应部分
                    const stepNum = this.getAttribute('data-step');
                    console.log(`跳转到步骤 ${stepNum}`);
                });
            });
        }
        
        function recalculateAll() {
            calculateSingleProduct();
            updateMultiProductSummary();
        }
        
        function calculateSingleProduct() {
            // 获取输入值
            const competitorPrice = parseFloat(document.getElementById('competitorPrice').value) || 0;
            const msrpRate = parseFloat(document.getElementById('msrpRate').value) || 0;
            const factoryDiscount = parseFloat(document.getElementById('factoryDiscount').value) || 0;
            const floorPriceRate = parseFloat(document.getElementById('floorPriceRate').value) || 0;
            const rebateRate = parseFloat(document.getElementById('rebateRate').value) || 0;
            const salesVolume = parseFloat(document.getElementById('salesVolume').value) || 0;
            
            // 计算核心值
            const msrp = competitorPrice * (msrpRate / 100);
            const factoryPrice = msrp * (factoryDiscount / 100);
            const channelMargin = msrp - factoryPrice;
            const floorPrice = msrp * (floorPriceRate / 100);
            
            // 计算分销商价格（假设从代理商进货）
            const distributorPrice = factoryPrice + channelMargin * 0.5; // 代理商加价50%的渠道利润给分销商
            const distributorMargin = msrp - distributorPrice;
            
            // 计算返点影响
            const rebateAmount = factoryPrice * (rebateRate / 100); // 返点基于出厂价
            const coreAgentActualMargin = channelMargin + rebateAmount;
            const coreAgentMarginRate = (channelMargin / msrp) * 100;
            const coreAgentRebateRate = (coreAgentActualMargin / msrp) * 100;
            const distributorMarginRate = (distributorMargin / msrp) * 100;
            
            // 计算营收
            const annualRevenueMsrp = msrp * salesVolume;
            const annualRevenueFactory = factoryPrice * salesVolume;
            const companyMargin = factoryPrice * salesVolume; // 假设成本为0
            const totalChannelMargin = channelMargin * salesVolume;
            
            // 更新结果显示
            document.getElementById('msrpResult').textContent = '¥' + formatNumber(msrp.toFixed(0));
            document.getElementById('msrpFormula').textContent = `${competitorPrice} × ${msrpRate}% = ${msrp.toFixed(0)}`;
            
            document.getElementById('factoryPriceResult').textContent = '¥' + formatNumber(factoryPrice.toFixed(0));
            document.getElementById('factoryPriceFormula').textContent = `${msrp.toFixed(0)} × ${factoryDiscount}% = ${factoryPrice.toFixed(0)}`;
            
            document.getElementById('channelMarginResult').textContent = '¥' + formatNumber(channelMargin.toFixed(0));
            document.getElementById('channelMarginFormula').textContent = `${msrp.toFixed(0)} - ${factoryPrice.toFixed(0)} = ${channelMargin.toFixed(0)}`;
            
            document.getElementById('floorPriceResult').textContent = '¥' + formatNumber(floorPrice.toFixed(0));
            document.getElementById('floorPriceFormula').textContent = `${msrp.toFixed(0)} × ${floorPriceRate}% = ${floorPrice.toFixed(0)}`;
            
            // 更新渠道利润分析表
            document.getElementById('coreAgentPrice').textContent = '¥' + formatNumber(factoryPrice.toFixed(0));
            document.getElementById('coreAgentMsrp').textContent = '¥' + formatNumber(msrp.toFixed(0));
            document.getElementById('coreAgentMargin').textContent = '¥' + formatNumber(channelMargin.toFixed(0));
            document.getElementById('coreAgentMarginRate').textContent = coreAgentMarginRate.toFixed(0) + '%';
            document.getElementById('coreAgentRebateRate').textContent = coreAgentRebateRate.toFixed(0) + '%';
            
            document.getElementById('distributorPrice').textContent = '¥' + formatNumber(distributorPrice.toFixed(0));
            document.getElementById('distributorMsrp').textContent = '¥' + formatNumber(msrp.toFixed(0));
            document.getElementById('distributorMargin').textContent = '¥' + formatNumber(distributorMargin.toFixed(0));
            document.getElementById('distributorMarginRate').textContent = distributorMarginRate.toFixed(0) + '%';
            document.getElementById('distributorRebateRate').textContent = distributorMarginRate.toFixed(0) + '%';
            
            // 更新营收与利润测算表
            document.getElementById('annualRevenueMsrp').textContent = '¥' + formatNumber(annualRevenueMsrp.toFixed(0));
            document.getElementById('annualRevenueFactory').textContent = '¥' + formatNumber(annualRevenueFactory.toFixed(0));
            document.getElementById('companyMargin').textContent = '¥' + formatNumber(companyMargin.toFixed(0));
            document.getElementById('totalChannelMargin').textContent = '¥' + formatNumber(totalChannelMargin.toFixed(0));
            
            // 更新步骤指示器
            updateStepIndicator();
        }
        
        function updateStepIndicator() {
            // 根据计算完成更新步骤指示器
            const steps = document.querySelectorAll('.step');
            steps.forEach(step => {
                step.classList.remove('active');
            });
            
            // 激活所有步骤（表示计算完成）
            steps.forEach(step => {
                step.classList.add('active');
            });
        }
        
        function initializeMultiProductTable() {
            // 初始添加3个示例产品
            addProductRow('甲基化基因癌症早早筛查', 1200, 'A', 85, 40);
            addProductRow('免疫细胞CIK', 50000, 'B', 105, 45);
            addProductRow('食物不耐受检测FIGG198项', 5940, 'A', 80, 35);
            
            updateMultiProductSummary();
        }
        
        function addProductRow(name, price, strategy, msrpRate, factoryDiscount) {
            const tbody = document.getElementById('multiProductBody');
            const rowId = 'product_' + Date.now() + Math.random();
            
            const row = document.createElement('tr');
            row.id = rowId;
            
            // 设置默认值
            name = name || `产品${tbody.children.length + 1}`;
            price = price || 1000;
            strategy = strategy || 'A';
            msrpRate = msrpRate || 85;
            factoryDiscount = factoryDiscount || 40;
            
            // 计算衍生值
            const msrp = price * (msrpRate / 100);
            const factoryPrice = msrp * (factoryDiscount / 100);
            const channelMargin = msrp - factoryPrice;
            
            row.innerHTML = `
                <td><input type="text" class="multi-input" value="${name}" data-field="name"></td>
                <td><input type="number" class="multi-input" value="${price}" data-field="price" step="10"></td>
                <td>
                    <select class="multi-input" data-field="strategy">
                        <option value="A" ${strategy === 'A' ? 'selected' : ''}>策略A</option>
                        <option value="B" ${strategy === 'B' ? 'selected' : ''}>策略B</option>
                    </select>
                </td>
                <td><input type="number" class="multi-input" value="${msrpRate}" data-field="msrpRate" min="60" max="110" step="1">%</td>
                <td><input type="number" class="multi-input" value="${factoryDiscount}" data-field="factoryDiscount" min="30" max="50" step="1">%</td>
                <td>¥${formatNumber(msrp.toFixed(0))}</td>
                <td>¥${formatNumber(factoryPrice.toFixed(0))}</td>
                <td>¥${formatNumber(channelMargin.toFixed(0))}</td>
                <td><button class="btn-small" onclick="deleteProductRow('${rowId}')">删除</button></td>
            `;
            
            tbody.appendChild(row);
            
            // 存储产品数据
            multiProducts.push({
                id: rowId,
                name: name,
                price: price,
                strategy: strategy,
                msrpRate: msrpRate,
                factoryDiscount: factoryDiscount,
                msrp: msrp,
                factoryPrice: factoryPrice,
                channelMargin: channelMargin
            });
            
            // 绑定输入事件
            const inputs = row.querySelectorAll('.multi-input');
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    updateProductRow(rowId);
                });
                input.addEventListener('change', function() {
                    updateProductRow(rowId);
                });
            });
            
            updateMultiProductSummary();
        }
        
        function updateProductRow(rowId) {
            const row = document.getElementById(rowId);
            if (!row) return;
            
            // 获取输入值
            const name = row.querySelector('[data-field="name"]').value;
            const price = parseFloat(row.querySelector('[data-field="price"]').value) || 0;
            const strategy = row.querySelector('[data-field="strategy"]').value;
            let msrpRate = parseFloat(row.querySelector('[data-field="msrpRate"]').value) || 0;
            let factoryDiscount = parseFloat(row.querySelector('[data-field="factoryDiscount"]').value) || 0;
            
            // 根据策略限制MSRP比例
            if (strategy === 'A') {
                if (msrpRate < 60) msrpRate = 60;
                if (msrpRate > 85) msrpRate = 85;
                row.querySelector('[data-field="msrpRate"]').value = msrpRate;
            } else {
                if (msrpRate < 100) msrpRate = 100;
                if (msrpRate > 110) msrpRate = 110;
                row.querySelector('[data-field="msrpRate"]').value = msrpRate;
            }
            
            // 限制出厂折扣
            if (factoryDiscount < 30) factoryDiscount = 30;
            if (factoryDiscount > 50) factoryDiscount = 50;
            row.querySelector('[data-field="factoryDiscount"]').value = factoryDiscount;
            
            // 计算衍生值
            const msrp = price * (msrpRate / 100);
            const factoryPrice = msrp * (factoryDiscount / 100);
            const channelMargin = msrp - factoryPrice;
            
            // 更新显示
            const cells = row.querySelectorAll('td');
            cells[5].textContent = '¥' + formatNumber(msrp.toFixed(0));
            cells[6].textContent = '¥' + formatNumber(factoryPrice.toFixed(0));
            cells[7].textContent = '¥' + formatNumber(channelMargin.toFixed(0));
            
            // 更新存储的数据
            const productIndex = multiProducts.findIndex(p => p.id === rowId);
            if (productIndex !== -1) {
                multiProducts[productIndex] = {
                    id: rowId,
                    name: name,
                    price: price,
                    strategy: strategy,
                    msrpRate: msrpRate,
                    factoryDiscount: factoryDiscount,
                    msrp: msrp,
                    factoryPrice: factoryPrice,
                    channelMargin: channelMargin
                };
            }
            
            updateMultiProductSummary();
        }
        
        function deleteProductRow(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                row.remove();
                
                // 从数组中移除
                const productIndex = multiProducts.findIndex(p => p.id === rowId);
                if (productIndex !== -1) {
                    multiProducts.splice(productIndex, 1);
                }
                
                updateMultiProductSummary();
            }
        }
        
        function clearProducts() {
            const tbody = document.getElementById('multiProductBody');
            tbody.innerHTML = '';
            multiProducts = [];
            updateMultiProductSummary();
        }
        
        function updateMultiProductSummary() {
            const productCount = multiProducts.length;
            
            if (productCount === 0) {
                document.getElementById('productCount').textContent = '0';
                document.getElementById('avgMsrpRate').textContent = '0%';
                document.getElementById('avgFactoryDiscount').textContent = '0%';
                document.getElementById('totalRevenueMsrp').textContent = '¥0';
                document.getElementById('totalRevenueFactory').textContent = '¥0';
                document.getElementById('totalChannelMarginMulti').textContent = '¥0';
                return;
            }
            
            // 计算平均值
            const avgMsrpRate = multiProducts.reduce((sum, p) => sum + p.msrpRate, 0) / productCount;
            const avgFactoryDiscount = multiProducts.reduce((sum, p) => sum + p.factoryDiscount, 0) / productCount;
            
            // 计算总和（假设每个产品年销售100单位）
            const assumptionVolume = 100;
            const totalRevenueMsrp = multiProducts.reduce((sum, p) => sum + p.msrp * assumptionVolume, 0);
            const totalRevenueFactory = multiProducts.reduce((sum, p) => sum + p.factoryPrice * assumptionVolume, 0);
            const totalChannelMargin = multiProducts.reduce((sum, p) => sum + p.channelMargin * assumptionVolume, 0);
            
            // 更新显示
            document.getElementById('productCount').textContent = productCount;
            document.getElementById('avgMsrpRate').textContent = avgMsrpRate.toFixed(1) + '%';
            document.getElementById('avgFactoryDiscount').textContent = avgFactoryDiscount.toFixed(1) + '%';
            document.getElementById('totalRevenueMsrp').textContent = '¥' + formatNumber(totalRevenueMsrp.toFixed(0));
            document.getElementById('totalRevenueFactory').textContent = '¥' + formatNumber(totalRevenueFactory.toFixed(0));
            document.getElementById('totalChannelMarginMulti').textContent = '¥' + formatNumber(totalChannelMargin.toFixed(0));
        }
        
        function updateScenario() {
            const scenarioType = document.getElementById('scenarioType').value;
            const basePrice = parseFloat(document.getElementById('baseCompetitorPrice').value) || 1200;
            
            let msrpRate, factoryDiscount, rebateRate, floorPriceRate, description;
            
            switch(scenarioType) {
                case 'aggressive':
                    msrpRate = 70;
                    factoryDiscount = 32;
                    rebateRate = 18;
                    floorPriceRate = 88;
                    description = "快速抢占市场份额，通过高渠道利润和返点激励渠道快速铺货，MSRP定价具有明显竞争力。";
                    break;
                case 'balanced':
                    msrpRate = 85;
                    factoryDiscount = 40;
                    rebateRate = 12;
                    floorPriceRate = 92;
                    description = "平衡市场占有率与利润，兼顾渠道激励与品牌价值建设，适合中长期发展。";
                    break;
                case 'premium':
                    msrpRate = 105;
                    factoryDiscount = 48;
                    rebateRate = 10;
                    floorPriceRate = 98;
                    description = "定位高端市场，强调产品价值与专业服务，渠道利润适中但品牌溢价高。";
                    break;
                case 'channelFocused':
                    msrpRate = 78;
                    factoryDiscount = 35;
                    rebateRate = 22;
                    floorPriceRate = 87;
                    description = "高度依赖渠道驱动，给予渠道极高的利润空间和返点激励，快速建立分销网络。";
                    break;
                default:
                    msrpRate = 85;
                    factoryDiscount = 40;
                    rebateRate = 15;
                    floorPriceRate = 95;
                    description = "标准策略";
            }
            
            // 计算场景结果
            const msrp = basePrice * (msrpRate / 100);
            const factoryPrice = msrp * (factoryDiscount / 100);
            const channelMargin = msrp - factoryPrice;
            const floorPrice = msrp * (floorPriceRate / 100);
            
            // 显示结果
            const resultsHtml = `
                <h3>${getScenarioName(scenarioType)}策略结果</h3>
                <p>${description}</p>
                <div class="results-grid">
                    <div class="result-card">
                        <h3>MSRP定价比例</h3>
                        <div class="result-value">${msrpRate}%</div>
                        <div class="result-desc">基于竞品价${formatNumber(basePrice)}元</div>
                    </div>
                    <div class="result-card">
                        <h3>代理出厂价折扣</h3>
                        <div class="result-value">${factoryDiscount}%</div>
                        <div class="result-desc">基于MSRP</div>
                    </div>
                    <div class="result-card">
                        <h3>核心代理返点</h3>
                        <div class="result-value">${rebateRate}%</div>
                        <div class="result-desc">基于出厂价</div>
                    </div>
                    <div class="result-card">
                        <h3>市场保护价比例</h3>
                        <div class="result-value">${floorPriceRate}%</div>
                        <div class="result-desc">基于MSRP</div>
                    </div>
                </div>
                <div class="results-grid" style="margin-top: 20px;">
                    <div class="result-card">
                        <h3>制造商建议零售价</h3>
                        <div class="result-value">¥${formatNumber(msrp.toFixed(0))}</div>
                        <div class="result-desc">${formatNumber(basePrice)} × ${msrpRate}%</div>
                    </div>
                    <div class="result-card">
                        <h3>代理赋能出厂价</h3>
                        <div class="result-value">¥${formatNumber(factoryPrice.toFixed(0))}</div>
                        <div class="result-desc">${formatNumber(msrp.toFixed(0))} × ${factoryDiscount}%</div>
                    </div>
                    <div class="result-card">
                        <h3>渠道利润空间</h3>
                        <div class="result-value">¥${formatNumber(channelMargin.toFixed(0))}</div>
                        <div class="result-desc">${formatNumber(msrp.toFixed(0))} - ${formatNumber(factoryPrice.toFixed(0))}</div>
                    </div>
                    <div class="result-card">
                        <h3>最低市场保护价</h3>
                        <div class="result-value">¥${formatNumber(floorPrice.toFixed(0))}</div>
                        <div class="result-desc">${formatNumber(msrp.toFixed(0))} × ${floorPriceRate}%</div>
                    </div>
                </div>
            `;
            
            document.getElementById('scenarioResults').innerHTML = resultsHtml;
        }
        
        function getScenarioName(type) {
            switch(type) {
                case 'aggressive': return '激进抢占市场';
                case 'balanced': return '平衡发展';
                case 'premium': return '高端价值定位';
                case 'channelFocused': return '渠道驱动型';
                default: return '标准';
            }
        }
        
        function resetAll() {
            // 重置所有输入到默认值
            document.getElementById('productName').value = '甲基化基因癌症早早筛查';
            document.getElementById('competitorPrice').value = '1200';
            document.getElementById('strategyType').value = 'A';
            document.getElementById('msrpRate').value = '85';
            document.getElementById('msrpRateValue').textContent = '85%';
            document.getElementById('factoryDiscount').value = '40';
            document.getElementById('factoryDiscountValue').textContent = '40%';
            document.getElementById('floorPriceRate').value = '95';
            document.getElementById('floorPriceRateValue').textContent = '95%';
            document.getElementById('rebateThreshold').value = '100';
            document.getElementById('rebateRate').value = '15';
            document.getElementById('salesVolume').value = '1000';
            
            // 重新计算
            recalculateAll();
        }
        
        function downloadExcel() {
            // 创建数据对象
            const data = {
                '单品测算': getSingleProductData(),
                '多产品测算': getMultiProductData(),
                '策略场景': getScenarioData()
            };
            
            // 创建CSV内容
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // 添加单品测算数据
            csvContent += "单品测算\r\n";
            const singleData = data['单品测算'];
            for (const [key, value] of Object.entries(singleData)) {
                csvContent += `${key},${value}\r\n`;
            }
            csvContent += "\r\n\r\n";
            
            // 添加多产品测算数据
            csvContent += "多产品测算\r\n";
            csvContent += "产品名称,竞品价,策略,MSRP比例(%),出厂折扣(%),MSRP,出厂价,渠道利润\r\n";
            const multiData = data['多产品测算'];
            multiData.forEach(product => {
                csvContent += `${product.name},${product.price},${product.strategy},${product.msrpRate},${product.factoryDiscount},${product.msrp},${product.factoryPrice},${product.channelMargin}\r\n`;
            });
            
            // 创建下载链接
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "双细价格体系测算数据.csv");
            document.body.appendChild(link);
            
            // 触发下载
            link.click();
            document.body.removeChild(link);
            
            alert("数据已导出为CSV文件，可在Excel中打开。");
        }
        
        function getSingleProductData() {
            const competitorPrice = parseFloat(document.getElementById('competitorPrice').value) || 0;
            const msrpRate = parseFloat(document.getElementById('msrpRate').value) || 0;
            const factoryDiscount = parseFloat(document.getElementById('factoryDiscount').value) || 0;
            const floorPriceRate = parseFloat(document.getElementById('floorPriceRate').value) || 0;
            const rebateRate = parseFloat(document.getElementById('rebateRate').value) || 0;
            const salesVolume = parseFloat(document.getElementById('salesVolume').value) || 0;
            
            const msrp = competitorPrice * (msrpRate / 100);
            const factoryPrice = msrp * (factoryDiscount / 100);
            const channelMargin = msrp - factoryPrice;
            const floorPrice = msrp * (floorPriceRate / 100);
            const annualRevenueMsrp = msrp * salesVolume;
            const annualRevenueFactory = factoryPrice * salesVolume;
            
            return {
                '产品名称': document.getElementById('productName').value,
                '竞品价': competitorPrice,
                '策略': document.getElementById('strategyType').value === 'A' ? '策略A(主攻)' : '策略B(价值)',
                'MSRP定价比例(%)': msrpRate,
                '制造商建议零售价(MSRP)': msrp.toFixed(2),
                '代理出厂价折扣(%)': factoryDiscount,
                '代理赋能出厂价': factoryPrice.toFixed(2),
                '渠道利润空间': channelMargin.toFixed(2),
                '最低市场保护价比例(%)': floorPriceRate,
                '最低市场保护价': floorPrice.toFixed(2),
                '核心代理返点比例(%)': rebateRate,
                '预计年销售量': salesVolume,
                '预计年营收(MSRP基准)': annualRevenueMsrp.toFixed(2),
                '预计年回款(出厂价基准)': annualRevenueFactory.toFixed(2),
                '测算时间': new Date().toLocaleString()
            };
        }
        
        function getMultiProductData() {
            return multiProducts;
        }
        
        function getScenarioData() {
            const scenarioType = document.getElementById('scenarioType').value;
            const basePrice = parseFloat(document.getElementById('baseCompetitorPrice').value) || 0;
            
            return {
                '场景类型': getScenarioName(scenarioType),
                '基准竞品价': basePrice,
                '生成时间': new Date().toLocaleString()
            };
        }
        
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        // 使deleteProductRow函数在全局可访问
        window.deleteProductRow = deleteProductRow;
    </script>
</body>
</html>
